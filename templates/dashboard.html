<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Bot Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: #161b22 !important;
            border-bottom: 1px solid #30363d;
        }
        
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: #21262d;
            border-bottom: 1px solid #30363d;
            color: #f0f6fc;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        
        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }
        
        .btn-danger {
            background-color: #da3633;
            border-color: #da3633;
        }
        
        .btn-warning {
            background-color: #fb8500;
            border-color: #fb8500;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-stopped {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00d4aa;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #8b949e;
            text-transform: uppercase;
        }
        
        .prediction-positive {
            color: #28a745;
        }
        
        .prediction-negative {
            color: #dc3545;
        }
        
        .confidence-high {
            color: #28a745;
        }
        
        .confidence-medium {
            color: #ffc107;
        }
        
        .confidence-low {
            color: #dc3545;
        }
        
        .table-dark {
            background-color: #161b22;
        }
        
        .table-dark td, .table-dark th {
            border-color: #30363d;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: #00d4aa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot"></i> AI Trading Bot Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item">
                    <span id="bot-status" class="nav-link">
                        <span class="status-indicator status-stopped"></span>
                        Initializing...
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-control-panel"></i> Control Panel
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button id="start-bot-btn" class="btn btn-primary w-100">
                                    <i class="fas fa-play"></i> Start Bot
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="stop-bot-btn" class="btn btn-danger w-100">
                                    <i class="fas fa-stop"></i> Stop Bot
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="train-models-btn" class="btn btn-warning w-100">
                                    <i class="fas fa-brain"></i> Train Models
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="run-backtest-btn" class="btn btn-info w-100">
                                    <i class="fas fa-chart-line"></i> Run Backtest
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="portfolio-value">$0.00</div>
                    <div class="metric-label">Portfolio Value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="cash-balance">$0.00</div>
                    <div class="metric-label">Cash Balance</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="daily-trades">0</div>
                    <div class="metric-label">Daily Trades</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="models-trained">0/8</div>
                    <div class="metric-label">Models Trained</div>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-area"></i> Performance Over Time
                    </div>
                    <div class="card-body">
                        <div id="performance-chart"></div>
                        <div id="chart-loading" class="loading">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading performance data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Current Predictions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-crystal-ball"></i> Current Predictions
                    </div>
                    <div class="card-body">
                        <div id="predictions-loading" class="loading">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading predictions...</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped" id="predictions-table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Prediction</th>
                                        <th>Confidence</th>
                                        <th>Signal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Positions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-briefcase"></i> Current Positions
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped" id="positions-table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Quantity</th>
                                        <th>Avg Price</th>
                                        <th>Current Price</th>
                                        <th>P&L</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Performance -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> Model Performance
                    </div>
                    <div class="card-body">
                        <div id="model-performance-content">
                            <div class="loading">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading model performance data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history"></i> Recent Trades
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped" id="trades-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Action</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>P&L</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let updateInterval;
        let botRunning = false;

        // Initialize dashboard
        $(document).ready(function() {
            updateDashboard();
            startAutoUpdate();
            setupEventHandlers();
        });

        function setupEventHandlers() {
            $('#start-bot-btn').click(function() {
                startBot();
            });

            $('#stop-bot-btn').click(function() {
                stopBot();
            });

            $('#train-models-btn').click(function() {
                trainModels();
            });

            $('#run-backtest-btn').click(function() {
                runBacktest();
            });
        }

        function startAutoUpdate() {
            updateInterval = setInterval(updateDashboard, 10000); // Update every 10 seconds
        }

        function stopAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }

        function updateDashboard() {
            updateStatus();
            updatePredictions();
            updatePositions();
            updateTradeHistory();
            updateModelPerformance();
            updatePerformanceChart();
        }

        function updateStatus() {
            $.get('/api/status', function(data) {
                if (data.error) {
                    console.error(data.error);
                    return;
                }

                // Update bot status
                const statusElement = $('#bot-status');
                const statusIndicator = statusElement.find('.status-indicator');
                
                if (data.bot_running) {
                    statusIndicator.removeClass('status-stopped').addClass('status-running');
                    statusElement.contents().last()[0].textContent = ' Bot Running';
                    botRunning = true;
                } else {
                    statusIndicator.removeClass('status-running').addClass('status-stopped');
                    statusElement.contents().last()[0].textContent = ' Bot Stopped';
                    botRunning = false;
                }

                // Update metrics - FIXED: Added missing '$' symbols
                $('#portfolio-value').text('$' + data.portfolio_value.toFixed(2));
                $('#cash-balance').text('$' + data.cash.toFixed(2));
                $('#daily-trades').text(data.daily_trades || 0);
                
                const totalModels = data.models_trained.traditional + data.models_trained.deep_learning;
                $('#models-trained').text(totalModels + '/16'); // 8 symbols × 2 model types
            });
        }

        function updatePredictions() {
            $('#predictions-loading').show();
            $('#predictions-table').hide();
            
            $.get('/api/predictions', function(data) {
                const tbody = $('#predictions-table tbody');
                tbody.empty();

                Object.entries(data).forEach(([symbol, prediction]) => {
                    if (prediction.error) {
                        tbody.append(`
                            <tr>
                                <td>${symbol}</td>
                                <td colspan="3" class="text-danger">Error: ${prediction.error}</td>
                            </tr>
                        `);
                        return;
                    }

                    const predValue = prediction.prediction;
                    const confidence = prediction.confidence;
                    
                    const predClass = predValue > 0 ? 'prediction-positive' : 'prediction-negative';
                    const confClass = confidence > 0.7 ? 'confidence-high' : 
                                     confidence > 0.5 ? 'confidence-medium' : 'confidence-low';
                    
                    const signal = predValue > 0.01 ? 'BUY' : predValue < -0.01 ? 'SELL' : 'HOLD';

                    tbody.append(`
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td class="${predClass}">${(predValue * 100).toFixed(2)}%</td>
                            <td class="${confClass}">${(confidence * 100).toFixed(0)}%</td>
                            <td>
                                <span class="badge ${signal === 'BUY' ? 'bg-success' : signal === 'SELL' ? 'bg-danger' : 'bg-secondary'}">
                                    ${signal}
                                </span>
                            </td>
                        </tr>
                    `);
                });

                $('#predictions-loading').hide();
                $('#predictions-table').show();
            });
        }

        function updatePositions() {
            $.get('/api/positions', function(data) {
                const tbody = $('#positions-table tbody');
                tbody.empty();

                if (Object.keys(data).length === 0) {
                    tbody.append(`
                        <tr>
                            <td colspan="6" class="text-center text-muted">No positions currently held</td>
                        </tr>
                    `);
                    return;
                }

                Object.entries(data).forEach(([symbol, position]) => {
                    const pnlClass = position.unrealized_pnl >= 0 ? 'text-success' : 'text-danger';
                    
                    tbody.append(`
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td>${position.quantity}</td>
                            <td>$${position.avg_price.toFixed(2)}</td>
                            <td>$${position.current_price.toFixed(2)}</td>
                            <td class="${pnlClass}">$${position.unrealized_pnl.toFixed(2)}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="closePosition('${symbol}')">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        function updateTradeHistory() {
            $.get('/api/trade_history', function(data) {
                const tbody = $('#trades-table tbody');
                tbody.empty();

                if (data.length === 0) {
                    tbody.append(`
                        <tr>
                            <td colspan="6" class="text-center text-muted">No trades executed yet</td>
                        </tr>
                    `);
                    return;
                }

                data.slice(-10).reverse().forEach(trade => {
                    const pnlClass = trade.pnl >= 0 ? 'text-success' : 'text-danger';
                    const actionClass = trade.action === 'BUY' ? 'text-success' : 'text-danger';
                    
                    tbody.append(`
                        <tr>
                            <td>${trade.timestamp}</td>
                            <td><strong>${trade.symbol}</strong></td>
                            <td class="${actionClass}">${trade.action}</td>
                            <td>${trade.quantity}</td>
                            <td>$${trade.price.toFixed(2)}</td>
                            <td class="${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                        </tr>
                    `);
                });
            });
        }

        function updateModelPerformance() {
            $.get('/api/model_performance', function(data) {
                const content = $('#model-performance-content');
                content.empty();

                if (Object.keys(data).length === 0) {
                    content.html(`
                        <div class="text-center text-muted">
                            <p>No model performance data available. Please train models first.</p>
                        </div>
                    `);
                    return;
                }

                let html = '<div class="row">';
                
                Object.entries(data).forEach(([symbol, performance]) => {
                    const traditionalModels = performance.traditional_models || {};
                    const dlAvailable = performance.deep_learning_available;
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <strong>${symbol}</strong>
                                </div>
                                <div class="card-body">
                                    <h6>Traditional Models:</h6>
                    `;
                    
                    Object.entries(traditionalModels).forEach(([modelName, metrics]) => {
                        html += `
                            <div class="mb-2">
                                <strong>${modelName.toUpperCase()}:</strong><br>
                                <small>R² Score: ${metrics.test_r2?.toFixed(3) || 'N/A'}</small><br>
                                <small>MSE: ${metrics.mse?.toFixed(6) || 'N/A'}</small>
                            </div>
                        `;
                    });
                    
                    html += `
                                    <h6 class="mt-3">Deep Learning:</h6>
                                    <small>${dlAvailable ? '✅ LSTM Model Available' : '❌ Not Trained'}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.html(html);
            });
        }

        function updatePerformanceChart() {
            $('#chart-loading').show();
            
            $.get('/api/performance_chart', function(data) {
                if (data.error) {
                    $('#performance-chart').html(`
                        <div class="text-center text-muted">
                            <p>${data.error}</p>
                        </div>
                    `);
                } else {
                    const chart = JSON.parse(data.chart);
                    Plotly.newPlot('performance-chart', chart.data, chart.layout, {responsive: true});
                }
                
                $('#chart-loading').hide();
            });
        }

        function startBot() {
            $.post('/api/start_bot', function(data) {
                showAlert(data.message, 'success');
                updateStatus();
            }).fail(function() {
                showAlert('Failed to start bot', 'danger');
            });
        }

        function stopBot() {
            $.post('/api/stop_bot', function(data) {
                showAlert(data.message, 'warning');
                updateStatus();
            }).fail(function() {
                showAlert('Failed to stop bot', 'danger');
            });
        }

        function trainModels() {
            $.post('/api/start_training', function(data) {
                showAlert(data.message + ' - This may take several minutes...', 'info');
            }).fail(function() {
                showAlert('Failed to start training', 'danger');
            });
        }

        function runBacktest() {
            const startDate = prompt('Enter start date (YYYY-MM-DD):', '2020-01-01');
            const endDate = prompt('Enter end date (YYYY-MM-DD):', '2023-12-31');
            
            if (startDate && endDate) {
                $.post('/api/backtest', {
                    start_date: startDate,
                    end_date: endDate
                }, function(data) {
                    showAlert(data.message, 'info');
                }).fail(function() {
                    showAlert('Failed to start backtest', 'danger');
                });
            }
        }

        function closePosition(symbol) {
            if (confirm(`Are you sure you want to close the position for ${symbol}?`)) {
                $.post('/api/close_position', {
                    symbol: symbol
                }, function(data) {
                    if (data.error) {
                        showAlert(data.error, 'danger');
                    } else {
                        showAlert(data.message, 'success');
                        updatePositions();
                        updateStatus();
                    }
                }).fail(function() {
                    showAlert('Failed to close position', 'danger');
                });
            }
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position: fixed; top: 70px; right: 20px; z-index: 9999; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').append(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }

        // Handle page visibility changes to pause/resume updates
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoUpdate();
            } else {
                startAutoUpdate();
                updateDashboard();
            }
        });
    </script>
</body>
</html>